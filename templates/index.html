<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulsera AR con Flask</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #111;
    }

    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    video,
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
      /* espejo tipo selfie */
    }
  </style>
</head>

<body>
  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <!-- Script de MediaPipe -->
  <script type="module">
    import {
      HandLandmarker,
      FilesetResolver,
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } },
      });
      video.srcObject = stream;
      return new Promise((resolve) => {
        video.onloadedmetadata = () => {
          resolve();
        };
      });
    }

    async function main() {
      await initCamera();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
      );

      const handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath:
            "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
        },
        runningMode: "VIDEO",
        numHands: 1,
      });

      async function predict() {
        const results = handLandmarker.detectForVideo(video, Date.now());
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.landmarks && results.landmarks.length > 0) {
          const hand = results.landmarks[0];
          const wrist = hand[0]; // punto de la mu√±eca

          const x = wrist.x * canvas.width;
          const y = wrist.y * canvas.height;

          ctx.beginPath();
          ctx.arc(x, y, 40, 0, 2 * Math.PI);
          ctx.strokeStyle = "gold";
          ctx.lineWidth = 8;
          ctx.stroke();
        }

        requestAnimationFrame(predict);
      }

      predict();
    }

    main();
  </script>
</body>

</html>